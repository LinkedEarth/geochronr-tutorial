<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Age-Uncertain Principal Component Analysis | Time-uncertain data analysis in R</title>
  <meta name="description" content="This book covers time-uncertain data analysis in R, primarily relying on the geoChronR package" />
  <meta name="generator" content="bookdown 0.22 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Age-Uncertain Principal Component Analysis | Time-uncertain data analysis in R" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This book covers time-uncertain data analysis in R, primarily relying on the geoChronR package" />
  <meta name="github-repo" content="linkedearth/time-uncertain-data-analysis-in-R" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Age-Uncertain Principal Component Analysis | Time-uncertain data analysis in R" />
  
  <meta name="twitter:description" content="This book covers time-uncertain data analysis in R, primarily relying on the geoChronR package" />
  

<meta name="author" content="Nick McKay" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="principal-components-analysis.html"/>

<script src="libs/header-attrs-2.9/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.0.1/anchor-sections.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.0.1/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">geoChronR Tutorial</a></li>
<li><a href="http://nickmckay.github.io/GeoChronR>geoChronR manual</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Welcome!</a></li>
<li class="chapter" data-level="2" data-path="installation.html"><a href="installation.html"><i class="fa fa-check"></i><b>2</b> Installing the software you need</a>
<ul>
<li class="chapter" data-level="2.1" data-path="installation.html"><a href="installation.html#loading-a-lipd-file"><i class="fa fa-check"></i><b>2.1</b> Loading a LiPD file</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="inputs.html"><a href="inputs.html"><i class="fa fa-check"></i><b>3</b> Data in geoChronR</a>
<ul>
<li class="chapter" data-level="3.1" data-path="inputs.html"><a href="inputs.html#loading-a-lipd-file-1"><i class="fa fa-check"></i><b>3.1</b> Loading a LiPD file</a></li>
<li class="chapter" data-level="3.2" data-path="inputs.html"><a href="inputs.html#loading-multiple-lipd-datasets"><i class="fa fa-check"></i><b>3.2</b> Loading multiple LiPD datasets</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="age-uncertain-correlation.html"><a href="age-uncertain-correlation.html"><i class="fa fa-check"></i><b>4</b> Age-uncertain correlation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="age-uncertain-correlation.html"><a href="age-uncertain-correlation.html#the-corens-function"><i class="fa fa-check"></i><b>4.1</b> The corEns() function</a></li>
<li class="chapter" data-level="4.2" data-path="age-uncertain-correlation.html"><a href="age-uncertain-correlation.html#plotting-the-results"><i class="fa fa-check"></i><b>4.2</b> Plotting the results</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="age-uncertain-correlation.html"><a href="age-uncertain-correlation.html#significance-testing-options"><i class="fa fa-check"></i><b>4.2.1</b> Significance testing options</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="age-uncertain-correlation.html"><a href="age-uncertain-correlation.html#judging-the-overall-significance-of-an-age-uncertain-correlation"><i class="fa fa-check"></i><b>4.3</b> Judging the overall significance of an age-uncertain correlation</a></li>
<li class="chapter" data-level="4.4" data-path="age-uncertain-correlation.html"><a href="age-uncertain-correlation.html#conclusions"><i class="fa fa-check"></i><b>4.4</b> Conclusions</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html"><i class="fa fa-check"></i><b>5</b> Regression and Calibration-in-time</a>
<ul>
<li class="chapter" data-level="5.1" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#load-the-lipd-file"><i class="fa fa-check"></i><b>5.1</b> Load the LiPD file</a></li>
<li class="chapter" data-level="5.2" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#check-out-the-contents"><i class="fa fa-check"></i><b>5.2</b> Check out the contents</a></li>
<li class="chapter" data-level="5.3" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#create-an-age-model-with-bacon"><i class="fa fa-check"></i><b>5.3</b> Create an age model with Bacon</a></li>
<li class="chapter" data-level="5.4" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#and-plot-the-ensemble-output"><i class="fa fa-check"></i><b>5.4</b> And plot the ensemble output</a></li>
<li class="chapter" data-level="5.5" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#map-the-age-ensemble-to-the-paleodata-table"><i class="fa fa-check"></i><b>5.5</b> Map the age ensemble to the paleodata table</a></li>
<li class="chapter" data-level="5.6" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#select-the-paleodata-age-ensemble-and-rabd-data-that-wed-like-to-regress-and-calibrate"><i class="fa fa-check"></i><b>5.6</b> Select the paleodata age ensemble, and RABD data that we’d like to regress and calibrate</a></li>
<li class="chapter" data-level="5.7" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#now-load-in-the-instrumental-data-we-want-to-correlate-and-regress-agains"><i class="fa fa-check"></i><b>5.7</b> Now load in the instrumental data we want to correlate and regress agains</a></li>
<li class="chapter" data-level="5.8" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#check-agetime-units-before-proceeding"><i class="fa fa-check"></i><b>5.8</b> Check age/time units before proceeding</a></li>
<li class="chapter" data-level="5.9" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#create-a-variable-list-for-the-instrumental-data"><i class="fa fa-check"></i><b>5.9</b> Create a “variable list” for the instrumental data</a></li>
<li class="chapter" data-level="5.10" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#calculate-an-ensmeble-correlation-between-the-rabd-and-local-summer-temperature-data"><i class="fa fa-check"></i><b>5.10</b> Calculate an ensmeble correlation between the RABD and local summer temperature data</a></li>
<li class="chapter" data-level="5.11" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#and-plot-the-output"><i class="fa fa-check"></i><b>5.11</b> And plot the output</a></li>
<li class="chapter" data-level="5.12" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#perform-ensemble-regression"><i class="fa fa-check"></i><b>5.12</b> Perform ensemble regression</a></li>
<li class="chapter" data-level="5.13" data-path="regression-and-calibration-in-time.html"><a href="regression-and-calibration-in-time.html#and-plot-the-output-1"><i class="fa fa-check"></i><b>5.13</b> And plot the output</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="spectral-analysis.html"><a href="spectral-analysis.html"><i class="fa fa-check"></i><b>6</b> Spectral Analysis</a>
<ul>
<li class="chapter" data-level="6.1" data-path="spectral-analysis.html"><a href="spectral-analysis.html#time-certain-spectral-analysis"><i class="fa fa-check"></i><b>6.1</b> Time-certain spectral analysis</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="spectral-analysis.html"><a href="spectral-analysis.html#lomb-scargle-periodogram"><i class="fa fa-check"></i><b>6.1.1</b> Lomb-Scargle periodogram</a></li>
<li class="chapter" data-level="6.1.2" data-path="spectral-analysis.html"><a href="spectral-analysis.html#multi-taper-method"><i class="fa fa-check"></i><b>6.1.2</b> Multi-taper Method</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="spectral-analysis.html"><a href="spectral-analysis.html#time-uncertain-spectral-analysis"><i class="fa fa-check"></i><b>6.2</b> Time-uncertain spectral analysis</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="principal-components-analysis.html"><a href="principal-components-analysis.html"><i class="fa fa-check"></i><b>7</b> Principal Components Analysis</a></li>
<li class="chapter" data-level="8" data-path="age-uncertain-principal-component-analysis.html"><a href="age-uncertain-principal-component-analysis.html"><i class="fa fa-check"></i><b>8</b> Age-Uncertain Principal Component Analysis</a>
<ul>
<li class="chapter" data-level="8.1" data-path="age-uncertain-principal-component-analysis.html"><a href="age-uncertain-principal-component-analysis.html#make-a-map"><i class="fa fa-check"></i><b>8.1</b> Make a map</a></li>
<li class="chapter" data-level="8.2" data-path="age-uncertain-principal-component-analysis.html"><a href="age-uncertain-principal-component-analysis.html#prepare-the-data-for-pca"><i class="fa fa-check"></i><b>8.2</b> Prepare the data for PCA</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="age-uncertain-principal-component-analysis.html"><a href="age-uncertain-principal-component-analysis.html#grab-the-age-ensembles-for-each-record."><i class="fa fa-check"></i><b>8.2.1</b> Grab the age ensembles for each record.</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="age-uncertain-principal-component-analysis.html"><a href="age-uncertain-principal-component-analysis.html#calculate-the-ensemble-pca"><i class="fa fa-check"></i><b>8.3</b> Calculate the ensemble PCA</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="age-uncertain-principal-component-analysis.html"><a href="age-uncertain-principal-component-analysis.html#plot-the-ensemble-pca-results"><i class="fa fa-check"></i><b>8.3.1</b> Plot the ensemble PCA results</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="age-uncertain-principal-component-analysis.html"><a href="age-uncertain-principal-component-analysis.html#ensemble-pca-take-two---using-a-covariance-matrix."><i class="fa fa-check"></i><b>8.4</b> Ensemble PCA take two - using a covariance matrix.</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Time-uncertain data analysis in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="age-uncertain-principal-component-analysis" class="section level1" number="8">
<h1><span class="header-section-number">Chapter 8</span> Age-Uncertain Principal Component Analysis</h1>
<p>This vignette showcases the ability to perform principal component analysis (PCA, also known as empirical orthogonal function (EOF) analysis. Data are from the <a href="https://www.nature.com/articles/sdata201426">Arctic 2k</a> compilation, which we load here:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="age-uncertain-principal-component-analysis.html#cb3-1" aria-hidden="true" tabindex="-1"></a>  FD <span class="ot">&lt;-</span> lipdR<span class="sc">::</span><span class="fu">readLipd</span>(<span class="st">&quot;http://lipdverse.org/geoChronR-examples/arc2k/Arctic2k.zip&quot;</span>) </span></code></pre></div>
<pre><code>## [1] &quot;reading: Arc-Agassiz.Vinther.2008.lpd&quot;
## [1] &quot;reading: Arc-Austfonna.Isaksson.2005.lpd&quot;
## [1] &quot;reading: Arc-CampCentury.Fisher.1969.lpd&quot;
## [1] &quot;reading: Arc-Crete.Vinther.2010.lpd&quot;
## [1] &quot;reading: Arc-DevonIceCap.Fisher.1983.lpd&quot;
## [1] &quot;reading: Arc-Dye.Vinther.2010.lpd&quot;
## [1] &quot;reading: Arc-GISP2.Grootes.1997.lpd&quot;
## [1] &quot;reading: Arc-GRIP.Vinther.2010.lpd&quot;
## [1] &quot;reading: Arc-Hvtrvatn.Larsen.2011.lpd&quot;
## [1] &quot;reading: Arc-LakeC2.Lamoureux.1996.lpd&quot;
## [1] &quot;reading: Arc-LakeDonardBaffinIsland.Moore.2001.lpd&quot;
## [1] &quot;reading: Arc-LakeLehmilampi.Haltia-Hovi.2007.lpd&quot;
## [1] &quot;reading: Arc-LakeNataujrvi.Ojala.2005.lpd&quot;
## [1] &quot;reading: Arc-LowerMurrayLake.Cook.2008.lpd&quot;
## [1] &quot;reading: Arc-NGRIP1.Vinther.2006.lpd&quot;
## [1] &quot;reading: Arc-NGTB16.Schwager.1998.lpd&quot;
## [1] &quot;reading: Arc-NGTB18.Schwager.1998.lpd&quot;
## [1] &quot;reading: Arc-NGTB21.Schwager.1998.lpd&quot;
## [1] &quot;reading: Arc-Renland.Vinther.2008.lpd&quot;</code></pre>
<div id="make-a-map" class="section level2" number="8.1">
<h2><span class="header-section-number">8.1</span> Make a map</h2>
<p>First, let’s take a quick look at where these records are located. geoChronR’s <code>mapLipd</code> function can create quick maps:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="age-uncertain-principal-component-analysis.html#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mapLipd</span>(FD,<span class="at">map.type =</span> <span class="st">&quot;line&quot;</span>,<span class="at">projection =</span> <span class="st">&quot;stereo&quot;</span>,<span class="at">f =</span> <span class="fl">0.1</span>)</span></code></pre></div>
<p><img src="Time-uncertain-data-analysis-in-R_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<p>More map projections are available too. A list is available here:
<code>?mapproject</code></p>
</div>
<div id="prepare-the-data-for-pca" class="section level2" number="8.2">
<h2><span class="header-section-number">8.2</span> Prepare the data for PCA</h2>
<div id="grab-the-age-ensembles-for-each-record." class="section level3" number="8.2.1">
<h3><span class="header-section-number">8.2.1</span> Grab the age ensembles for each record.</h3>
<p>Now we need to “map” (I know, a different kind of mapping) the age ensembles to paleo for all of these datasets. We’ll use purrr::map for this, but you could also do it with sapply(). In this case we’re going to specify that all of the age ensembles are named “ageEnsemble,” and that they don’t have a depth variable because they’re layer counted.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="age-uncertain-principal-component-analysis.html#cb6-1" aria-hidden="true" tabindex="-1"></a>FD2 <span class="ot">=</span> purrr<span class="sc">::</span><span class="fu">map</span>(FD,</span>
<span id="cb6-2"><a href="age-uncertain-principal-component-analysis.html#cb6-2" aria-hidden="true" tabindex="-1"></a>                 mapAgeEnsembleToPaleoData,</span>
<span id="cb6-3"><a href="age-uncertain-principal-component-analysis.html#cb6-3" aria-hidden="true" tabindex="-1"></a>                 <span class="at">strict.search =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-4"><a href="age-uncertain-principal-component-analysis.html#cb6-4" aria-hidden="true" tabindex="-1"></a>                 <span class="at">age.var =</span> <span class="st">&quot;ageEnsemble&quot;</span>,</span>
<span id="cb6-5"><a href="age-uncertain-principal-component-analysis.html#cb6-5" aria-hidden="true" tabindex="-1"></a>                 <span class="at">depth.var =</span> <span class="cn">NULL</span> )</span></code></pre></div>
<p>Now extract all the “timeseries” into at “TS object” that will facilitate working with multiple records.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="age-uncertain-principal-component-analysis.html#cb7-1" aria-hidden="true" tabindex="-1"></a>TS <span class="ot">&lt;-</span> <span class="fu">extractTs</span>(FD2)</span></code></pre></div>
<p>and filter the TS object to only include variables that have been interpreted as temperature. Here we’ll use <code>lipdR::filterTs</code> to filter the TS object.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="age-uncertain-principal-component-analysis.html#cb8-1" aria-hidden="true" tabindex="-1"></a>TS.filtered <span class="ot">&lt;-</span> <span class="fu">filterTs</span>(TS,<span class="st">&quot;interpretation1_variable == T&quot;</span>)</span></code></pre></div>
<p>OK, let’s make a quick plot stack to see what we’re dealing with.</p>
<p>The <code>lipdR::tidyTs</code> function will convert a TS into a long, “tidy” data.frame, where each observation has a row in a data.frame. This can be verbose, but is also useful for data analysis in the tidyverse framework.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="age-uncertain-principal-component-analysis.html#cb9-1" aria-hidden="true" tabindex="-1"></a>tidyDf <span class="ot">&lt;-</span> lipdR<span class="sc">::</span><span class="fu">tidyTs</span>(TS.filtered,<span class="at">age.var =</span> <span class="st">&quot;year&quot;</span>)</span></code></pre></div>
<p>A tidy data.frame is also the input for the <code>plotTimeseriesStack</code> function in geoChronR.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="age-uncertain-principal-component-analysis.html#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotTimeseriesStack</span>(tidyDf, </span>
<span id="cb10-2"><a href="age-uncertain-principal-component-analysis.html#cb10-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">color.var =</span> <span class="st">&quot;paleoData_variableName&quot;</span>, </span>
<span id="cb10-3"><a href="age-uncertain-principal-component-analysis.html#cb10-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">color.ramp =</span> <span class="fu">c</span>(<span class="st">&quot;DarkBlue&quot;</span>,<span class="st">&quot;Orange&quot;</span>,<span class="st">&quot;Black&quot;</span>,<span class="st">&quot;Dark Green&quot;</span>),</span>
<span id="cb10-4"><a href="age-uncertain-principal-component-analysis.html#cb10-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">line.size =</span> .<span class="dv">1</span>, </span>
<span id="cb10-5"><a href="age-uncertain-principal-component-analysis.html#cb10-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fill.alpha =</span> .<span class="dv">05</span>,</span>
<span id="cb10-6"><a href="age-uncertain-principal-component-analysis.html#cb10-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lab.size =</span> <span class="dv">2</span>,</span>
<span id="cb10-7"><a href="age-uncertain-principal-component-analysis.html#cb10-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lab.space =</span> <span class="dv">3</span>)</span></code></pre></div>
<p><img src="Time-uncertain-data-analysis-in-R_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Now bin all the data in the TS from 1400 to 2000, an interval of pretty good data coverage, into 5 year bins.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="age-uncertain-principal-component-analysis.html#cb11-1" aria-hidden="true" tabindex="-1"></a>binned.TS <span class="ot">&lt;-</span> <span class="fu">binTs</span>(TS.filtered,<span class="at">bin.vec =</span> <span class="fu">seq</span>(<span class="dv">1400</span>,<span class="dv">2000</span>,<span class="at">by=</span><span class="dv">5</span>),<span class="at">time.var =</span> <span class="st">&quot;ageEnsemble&quot;</span>)</span></code></pre></div>
<p>We’re now ready to calculate the PCA!</p>
</div>
</div>
<div id="calculate-the-ensemble-pca" class="section level2" number="8.3">
<h2><span class="header-section-number">8.3</span> Calculate the ensemble PCA</h2>
<p>Calculate PCA on each ensemble member:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="age-uncertain-principal-component-analysis.html#cb12-1" aria-hidden="true" tabindex="-1"></a>pcout <span class="ot">&lt;-</span> <span class="fu">pcaEns</span>(binned.TS)</span></code></pre></div>
<p>That was easy (because of all the work we did beforehand). But before we look at the results let’s take a look at a scree plot to get a sense of how many significant components we should expect.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="age-uncertain-principal-component-analysis.html#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotScreeEns</span>(pcout)</span></code></pre></div>
<p><img src="Time-uncertain-data-analysis-in-R_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<p>It looks like the first two components, shown in black with gray uncertainty shading, stand out above the null model (in red), but the third and beyond look marginal to insignficant. Let’s focus on the first two components.</p>
<div id="plot-the-ensemble-pca-results" class="section level3" number="8.3.1">
<h3><span class="header-section-number">8.3.1</span> Plot the ensemble PCA results</h3>
<p>Now let’s visualize the results. The <code>plotPcaEns</code> function will create multiple diagnostic figures of the results, and stitch them together.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="age-uncertain-principal-component-analysis.html#cb14-1" aria-hidden="true" tabindex="-1"></a>plotPCA <span class="ot">&lt;-</span>  <span class="fu">plotPcaEns</span>(pcout,<span class="at">TS =</span> TS.filtered,<span class="at">map.type =</span> <span class="st">&quot;line&quot;</span>,<span class="at">projection =</span> <span class="st">&quot;stereo&quot;</span>,<span class="at">bound.circ =</span> T,<span class="at">restrict.map.range =</span> T,<span class="at">f=</span>.<span class="dv">1</span>,<span class="at">legend.position =</span> <span class="fu">c</span>(<span class="fl">0.5</span>,.<span class="dv">6</span>),<span class="at">which.pcs =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>,<span class="at">which.leg =</span> <span class="dv">2</span>)</span></code></pre></div>
<p><img src="Time-uncertain-data-analysis-in-R_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>Nice! A summary plot that combines the major features is produced, but all of the components, are included in the “plotPCA” list that was exported.</p>
<p>For comparison with other datasets it can be useful to export quantile timeseries shown in the figures. <code>plotTimeseriesEnsRibbons()</code> can optionally be used to export the data rather than plotting them. The following will export the PC1 timeseries:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="age-uncertain-principal-component-analysis.html#cb15-1" aria-hidden="true" tabindex="-1"></a>quantileData <span class="ot">&lt;-</span> <span class="fu">plotTimeseriesEnsRibbons</span>(<span class="at">X =</span> pcout<span class="sc">$</span>age,<span class="at">Y =</span> pcout<span class="sc">$</span>PCs[,<span class="dv">1</span>,],<span class="at">export.quantiles =</span> <span class="cn">TRUE</span>)</span>
<span id="cb15-2"><a href="age-uncertain-principal-component-analysis.html#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="age-uncertain-principal-component-analysis.html#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(quantileData)</span></code></pre></div>
<pre><code>## # A tibble: 200 x 6
##     ages `0.025`   `0.25`  `0.5` `0.75` `0.975`
##    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
##  1 1408. -0.0633  0.0371  0.0945 0.154    0.274
##  2 1410.  0.0235  0.0898  0.131  0.170    0.240
##  3 1413.  0.0597  0.127   0.169  0.208    0.284
##  4 1416.  0.109   0.181   0.211  0.241    0.291
##  5 1419.  0.0875  0.146   0.175  0.204    0.246
##  6 1422. -0.0298  0.0465  0.0876 0.124    0.194
##  7 1425. -0.0352  0.0129  0.0401 0.0689   0.109
##  8 1428. -0.0977 -0.0296  0.0113 0.0472   0.116
##  9 1431. -0.0723 -0.00981 0.0283 0.0651   0.129
## 10 1434. -0.0700  0.00573 0.0503 0.0880   0.157
## # … with 190 more rows</code></pre>
</div>
</div>
<div id="ensemble-pca-take-two---using-a-covariance-matrix." class="section level2" number="8.4">
<h2><span class="header-section-number">8.4</span> Ensemble PCA take two - using a covariance matrix.</h2>
<p>Let’s repeat much of this analysis, but this time we’re only going to analyze the <span class="math inline">\(\delta^{18}O\)</span> data, keep them in their native values, and use a covariance matrix in the PCA analysis.</p>
<p>First, it looks like let’s look at all the names in the TS</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="age-uncertain-principal-component-analysis.html#cb17-1" aria-hidden="true" tabindex="-1"></a>var.names <span class="ot">&lt;-</span> <span class="fu">pullTsVariable</span>(TS, <span class="st">&quot;variableName&quot;</span>)</span></code></pre></div>
<p>Oops - looks like we didn’t use quite the correct name. Next time use:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="age-uncertain-principal-component-analysis.html#cb18-1" aria-hidden="true" tabindex="-1"></a>var.names <span class="ot">&lt;-</span> <span class="fu">pullTsVariable</span>(TS, <span class="st">&quot;paleoData_variableName&quot;</span>)</span></code></pre></div>
<p>and take a look at the unique variableNames in the TS</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="age-uncertain-principal-component-analysis.html#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(var.names)</span></code></pre></div>
<pre><code>## [1] &quot;d18O&quot;                    &quot;year&quot;                   
## [3] &quot;ageEnsemble&quot;             &quot;thickness&quot;              
## [5] &quot;X_radiograph_dark_layer&quot; &quot;massacum&quot;</code></pre>
<p>OK. Let’s filter the timeseries again, this time pulling all the <span class="math inline">\(\delta^{18}O\)</span> data.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="age-uncertain-principal-component-analysis.html#cb21-1" aria-hidden="true" tabindex="-1"></a>d18OTS <span class="ot">=</span> <span class="fu">filterTs</span>(TS,<span class="st">&quot;paleoData_variableName == d18O&quot;</span>)</span></code></pre></div>
<p>And we’ll tidy up the data for a plotStack</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="age-uncertain-principal-component-analysis.html#cb22-1" aria-hidden="true" tabindex="-1"></a>tidyd18O <span class="ot">&lt;-</span> <span class="fu">tidyTs</span>(d18OTS,<span class="at">age.var =</span> <span class="st">&quot;year&quot;</span>)</span></code></pre></div>
<p>Before plotting, let’s do some tidyverse gymnastics to reorder the data by the length of the observations</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="age-uncertain-principal-component-analysis.html#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co">#arrange the tidy dataframe by record length</span></span>
<span id="cb23-2"><a href="age-uncertain-principal-component-analysis.html#cb23-2" aria-hidden="true" tabindex="-1"></a>tidyd18O <span class="ot">&lt;-</span> tidyd18O <span class="sc">%&gt;%</span> <span class="co">#use the magrittr pipe for clarity</span></span>
<span id="cb23-3"><a href="age-uncertain-principal-component-analysis.html#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(paleoData_TSid) <span class="sc">%&gt;%</span> <span class="co">#group the data by column</span></span>
<span id="cb23-4"><a href="age-uncertain-principal-component-analysis.html#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">duration =</span> <span class="fu">max</span>(year) <span class="sc">-</span> <span class="fu">min</span>(year)) <span class="sc">%&gt;%</span> <span class="co">#create a new column for the duration</span></span>
<span id="cb23-5"><a href="age-uncertain-principal-component-analysis.html#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(duration) <span class="co"># and arrange the data by duration</span></span></code></pre></div>
<p>Again we’ll use <code>plotTimeseriesStack</code> to show all the data, now nicely arranged.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="age-uncertain-principal-component-analysis.html#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotTimeseriesStack</span>(tidyd18O, </span>
<span id="cb24-2"><a href="age-uncertain-principal-component-analysis.html#cb24-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">color.var =</span> <span class="st">&quot;paleoData_variableName&quot;</span>, <span class="co"># Color the data by the variable name (all the same in the case)</span></span>
<span id="cb24-3"><a href="age-uncertain-principal-component-analysis.html#cb24-3" aria-hidden="true" tabindex="-1"></a>                    <span class="at">color.ramp =</span> <span class="st">&quot;DarkBlue&quot;</span>, <span class="co">#colors to use</span></span>
<span id="cb24-4"><a href="age-uncertain-principal-component-analysis.html#cb24-4" aria-hidden="true" tabindex="-1"></a>                    <span class="at">line.size =</span> .<span class="dv">1</span>, </span>
<span id="cb24-5"><a href="age-uncertain-principal-component-analysis.html#cb24-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">fill.alpha =</span> .<span class="dv">05</span>,</span>
<span id="cb24-6"><a href="age-uncertain-principal-component-analysis.html#cb24-6" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lab.size =</span> <span class="dv">2</span>,</span>
<span id="cb24-7"><a href="age-uncertain-principal-component-analysis.html#cb24-7" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lab.space =</span> <span class="dv">2</span>,</span>
<span id="cb24-8"><a href="age-uncertain-principal-component-analysis.html#cb24-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">lab.buff =</span> <span class="fl">0.03</span>)</span></code></pre></div>
<p><img src="Time-uncertain-data-analysis-in-R_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<p>Well that sure is nice and tidy. Again, it looks like binning from 1400-2000 will give us good data coverage.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="age-uncertain-principal-component-analysis.html#cb25-1" aria-hidden="true" tabindex="-1"></a>binned.TS2 <span class="ot">&lt;-</span> <span class="fu">binTs</span>(d18OTS,<span class="at">bin.vec =</span> <span class="fu">seq</span>(<span class="dv">1400</span>,<span class="dv">2000</span>,<span class="at">by=</span><span class="dv">5</span>),<span class="at">na.col.rm =</span> T)</span></code></pre></div>
<p>And calculate the ensemble PCA, this time using a covariance matrix. By using a covariance, we’ll allow records that have larger variability in <span class="math inline">\(\delta^{18}O\)</span> to influence the PCA more, and those that have little variability will have little impact. This may or may not be a good idea, but it’s an important option to consider when possible.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="age-uncertain-principal-component-analysis.html#cb26-1" aria-hidden="true" tabindex="-1"></a>pcout2 <span class="ot">&lt;-</span> <span class="fu">pcaEns</span>(binned.TS2,<span class="at">pca.type =</span> <span class="st">&quot;cov&quot;</span>)</span></code></pre></div>
<p>Once again, let’s take a look at the scree plot:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="age-uncertain-principal-component-analysis.html#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plotScreeEns</span>(pcout2)</span></code></pre></div>
<p><img src="Time-uncertain-data-analysis-in-R_files/figure-html/unnamed-chunk-24-1.png" width="384" /></p>
<p>Once again, the first two components look good, but the third also looks to be likely above the 95% significance level, so let’s include the third PC in our plot this time as well.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="age-uncertain-principal-component-analysis.html#cb28-1" aria-hidden="true" tabindex="-1"></a>plotPCA2 <span class="ot">&lt;-</span>  <span class="fu">plotPcaEns</span>(pcout2,</span>
<span id="cb28-2"><a href="age-uncertain-principal-component-analysis.html#cb28-2" aria-hidden="true" tabindex="-1"></a>                        <span class="at">TS =</span> d18OTS,</span>
<span id="cb28-3"><a href="age-uncertain-principal-component-analysis.html#cb28-3" aria-hidden="true" tabindex="-1"></a>                        <span class="at">which.pcs =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,  </span>
<span id="cb28-4"><a href="age-uncertain-principal-component-analysis.html#cb28-4" aria-hidden="true" tabindex="-1"></a>                        <span class="at">map.type =</span> <span class="st">&quot;line&quot;</span>,</span>
<span id="cb28-5"><a href="age-uncertain-principal-component-analysis.html#cb28-5" aria-hidden="true" tabindex="-1"></a>                        <span class="at">projection =</span> <span class="st">&quot;stereo&quot;</span>,</span>
<span id="cb28-6"><a href="age-uncertain-principal-component-analysis.html#cb28-6" aria-hidden="true" tabindex="-1"></a>                        <span class="at">bound.circ =</span> T,</span>
<span id="cb28-7"><a href="age-uncertain-principal-component-analysis.html#cb28-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">restrict.map.range =</span> T,</span>
<span id="cb28-8"><a href="age-uncertain-principal-component-analysis.html#cb28-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">f=</span>.<span class="dv">2</span>)</span></code></pre></div>
<p><img src="Time-uncertain-data-analysis-in-R_files/figure-html/unnamed-chunk-25-1.png" width="768" /></p>
<p>Using only the <span class="math inline">\(\delta^{18}O\)</span> data and a covariance matrix, we get somewhat different results. The first PC timeseries looks similar to the first one, but the spatial pattern is somewhat difference, with stronger loadings in the northeast. The second PC looks to be a new pattern, although the third resembles PC2 from the first analysis.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="principal-components-analysis.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["Time-uncertain data analysis in R.pdf"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
